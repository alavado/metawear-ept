<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <style>
      h1, h2 {
        font-weight: normal;
        text-transform: uppercase;
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 2.5em;
      }
      h2 {
        font-size: 1em;
        text-indent: 40px;
      }
      #root {
        overflow: hidden;
      }
    </style>
  </head>
  <body id="root">
    <script>
      var cartesianLabels = ['samples', 'x-axis', 'y-axis', 'z-axis']

      function GraphSetting(min, max, shortName, labels) {
        this.range = [min, max];
        this.shortName = shortName;
        this.labels = labels;
      }

      const GraphConfig = {
        "Accelerometer": new GraphSetting(-21, 21, "acc", cartesianLabels),
        "Gyroscope" : new GraphSetting(-2100.0, 2100.0, "gyro", cartesianLabels),
        "Magnetometer" : new GraphSetting(-0.0025, 0.0025, "mag", cartesianLabels),
        "Quaternion" : new GraphSetting(-1.05, 1.05, "quat", [ 'samples', 'w', 'x', 'y', 'z']),
        "Euler Angles" : new GraphSetting(-365.0, 365.0, "euler", [ 'samples', 'pitch', 'roll', 'yaw' ]),
        "Linear Acceleration" : new GraphSetting(-21.0, 21.0, "lin-acc", cartesianLabels),
        "Gravity" : new GraphSetting(-21.0, 21.0, "gravity", cartesianLabels),
        "Ambient Light" : new GraphSetting(-10, 64000, "als", [ 'samples', 'illuminance' ]),
        "Pressure" : new GraphSetting(0, 110000, "pressure", [ 'samples', 'pressure' ]),
        "Temperature" : new GraphSetting(-45, 130, "temp", [ 'samples', 'temperature' ]),
        "Humidity" : new GraphSetting(-5, 105, "humidity", [ 'samples', 'relative humidity' ])
      }
    </script>
    <script>
      function setupGraph(name, width, height) {
        var title = document.createElement("h2");
        title.textContent = name;
        root.append(title)

        var realHeight = height - title.clientHeight - 10;

        var div = document.createElement("div");
        div.setAttribute("id", `chart-${name}`);
        div.setAttribute("style", `width: ${width}px; height: ${realHeight}px`);

        root.appendChild(div);

        return [div];
      }
    </script>
    <script>
      const refesh = 33
      const ipc = require('electron').ipcRenderer
      const Dygraph = require('dygraphs');

      let now = new Date().getTime();
      let states = {}
      let url = new URL(window.location);
      let params = new URLSearchParams(url.search.substring(1));

      let sensors = params.get('sensors').split(',').map(s => {
        let parts = s.split('=')
        return [parts[0], parseFloat(parts[1])]
      });
      let width = parseInt(params.get("width"));
      let height = (parseInt(params.get("height")) - 20) / sensors.length;
      let root = document.getElementById("root");
      const reference = 10

      sensors.forEach(s => {
        let config = GraphConfig[s[0]];

        var data = []
        var elements = setupGraph(s[0], width, height);
        var graph = new Dygraph(elements[0], data,
          {
            valueRange: config.range,
            labels: config.labels,
            axes: { 
              x: { 
                drawAxis : false,
                drawGrid: false
              }
            }
          });

        states[s[0]] = {
          'graph': graph, 
          'data': data,
          'maxDataPoints': width * (reference / s[1])
        };
        
        ipc.on(`update-${s[0]}-${params.get('mac')}`, (event, arg) => {
          arg.unshift(data.length)
          data.push(arg)
        })
      })

      setInterval(() => Object.values(states).forEach(s => s['graph'].updateOptions({
        'file': s['data'], 
        'dateWindow': [Math.max(0, s['data'].length - s['maxDataPoints']), Math.max(s['maxDataPoints'], s['data'].length)] 
      }), refesh));
    </script>
  </body>
</html>