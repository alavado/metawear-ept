<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../node_modules/rickshaw/rickshaw.min.css">
    <style>
      h1, h2 {
        font-weight: normal;
        text-transform: uppercase;
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 2.5em;
      }
      h2 {
        font-size: 1em;
        text-indent: 40px;
      }
      .rickshaw_graph .y_ticks {
        left: 0;
      }
    </style>
  </head>
  <body id="root">
    <script>
      function setupGraph(name, height) {
        var title = document.createElement("h2");
        title.textContent = name;
        root.append(title)

        var container = document.createElement("div");
        container.setAttribute("id", `container-${name}`);
        container.setAttribute("style", `display: flex;font-family: Arial, Helvetica, sans-serif;height: ${height}px`);

        var yaxis = document.createElement("div");
        yaxis.setAttribute("id", `yaxis-${name}`);
        yaxis.setAttribute("style", `width: 40px; height: ${height}px`);
        container.append(yaxis);

        var div = document.createElement("div");
        div.setAttribute("id", `chart-${name}`);
        div.setAttribute("style", `flex-grow: 1; height: ${height}px`);
        container.appendChild(div);

        root.appendChild(container);

        return [div, yaxis];
      }
    </script>
    <script>
      const refesh = 33
      // You can also require other files to run in this process
      const GraphConfig = require('../lib/graph-config.js')
      const ipc = require('electron').ipcRenderer
      global.jQuery = require('jquery')
      global.d3 = require('d3');
      var Rickshaw = require('rickshaw');

      let now = new Date().getTime();
      let states = {}
      let url = new URL(window.location);
      let params = new URLSearchParams(url.search.substring(1));

      let sensors = params.get('sensors').split(',');
      let width = parseInt(params.get("width"));
      let height = parseInt(params.get("height")) / sensors.length - 27;
      let root = document.getElementById("root");
      sensors.forEach(s => {
        var elements = setupGraph(s, height)
        var graph = new Rickshaw.Graph({
          element: elements[0],
          min: GraphConfig[s].min,
          max: GraphConfig[s].max,
          width: width - 50,
          height: height - 13,
          renderer: 'line',
          series: new Rickshaw.Series.FixedDuration(GraphConfig[s].attr, undefined, {
            timeInterval: 10,
            maxDataPoints: width,
            timeBase: now / 1000
          })
        });
        
        states[s] = {
          'graph': graph, 
          'y-axis': new Rickshaw.Graph.Axis.Y({
            graph: graph,
            ticksTreatment: 'fancy',
            orientation: 'left',
            element: elements[1]
          })
        }
        graph.render()
        
        ipc.on(`update-${s}-${params.get('mac')}`, function (event, arg) {
          states[s]['graph'].series.addData(GraphConfig[s].unpack(arg));
        })
      })

      setInterval(() => {
        Object.values(states).forEach(e => e['graph'].render())
      }, 33)
    </script>
  </body>
</html>
