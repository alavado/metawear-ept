<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../node_modules/dygraphs/dist/dygraph.min.css">
    <style>
      .legend {
        padding: 0px 5px 12px;
        transform: translate(+25%);
        position: relative;
        top: -5px;
        margin-bottom: -15px;
      }
      #root {
        overflow: hidden;
      }
    </style>
  </head>
  <body id="root">
    <script>
      var cartesianLabels = ['x-axis', 'y-axis', 'z-axis'], cartesianColors = [ 'red' , 'green', 'blue']

      function GraphSetting(min, max, shortName, labels, colors, ylabel) {
        var copy = labels.slice();
        copy.unshift('samples');

        this.range = [min, max];
        this.shortName = shortName;
        this.labels = copy;
        this.colors = colors;
        this.ylabel = ylabel;
      }

      const GraphConfig = {
        "Accelerometer": new GraphSetting(-16, 16, "acc", cartesianLabels, cartesianColors, "Gravity of Earth (g)"),
        "Gyroscope" : new GraphSetting(-2100.0, 2100.0, "gyro", cartesianLabels, cartesianColors, "Degrees per Second (°/s)"),
        "Magnetometer" : new GraphSetting(-0.0025, 0.0025, "mag", cartesianLabels, cartesianColors, "Tesla (T)"),
        "Quaternion" : new GraphSetting(-1.05, 1.05, "quat", [ 'w', 'x', 'y', 'z'], [ 'black', 'red' , 'green', 'blue'], "(1)"),
        "Euler Angles" : new GraphSetting(-365.0, 365.0, "euler", [ 'pitch', 'roll', 'yaw' ], cartesianColors, "Degrees (°)"),
        "Linear Acceleration" : new GraphSetting(-16, 16, "lin-acc", cartesianLabels, cartesianColors, "Gravity of Earth (g)"),
        "Gravity" : new GraphSetting(-16, 16, "gravity", cartesianLabels, cartesianColors, "Gravity of Earth (g)"),
        "Ambient Light" : new GraphSetting(-10, 64000, "als", [ 'illuminance' ], [ 'magenta' ], "Lux (lx"),
        "Pressure" : new GraphSetting(0, 110000, "pressure", [ 'pressure' ], [ 'steelblue'], "Pressure (Pa)"),
        "Temperature" : new GraphSetting(-45, 130, "temp", [ 'temperature' ], [ '#c05020' ], "Celsius (C)"),
        "Humidity" : new GraphSetting(-5, 105, "humidity", [ 'relative humidity' ], [ '#30c020' ], "Percent (%)")
      }
    </script>
    <script>
      function setupGraph(name, width, height) {
        var realHeight = height - 10;

        var div = document.createElement("div");
        div.setAttribute("id", `chart-${name}`);
        div.setAttribute("style", `width: ${width}px; height: ${realHeight}px`);
        root.appendChild(div);

        var legend = document.createElement("div");
        legend.setAttribute("id", `legend-${name}`);
        legend.setAttribute("class", 'legend');
        root.append(legend);

        return [div, legend];
      }
    </script>
    <script>
      const refesh = 33
      const ipc = require('electron').ipcRenderer
      const Dygraph = require('dygraphs');

      let now = new Date().getTime();
      let states = {}
      let url = new URL(window.location);
      let params = new URLSearchParams(url.search.substring(1));

      let sensors = params.get('sensors').split(',').map(s => {
        let parts = s.split('=')
        return [parts[0], parseFloat(parts[1])]
      });
      let width = parseInt(params.get("width"));
      let height = (parseInt(params.get("height")) - 20) / sensors.length;
      let root = document.getElementById("root");
      const reference = 10

      sensors.forEach(s => {
        let config = GraphConfig[s[0]];

        var data = []
        var elements = setupGraph(s[0], width, height);
        var graph = new Dygraph(elements[0], data,
          {
            valueRange: config.range,
            labels: config.labels,
            axes: { 
              x: { 
                drawAxis : false,
                drawGrid: false
              }
            },
            labelsDiv: elements[1],
            legend: 'always',
            title: s[0],
            ylabel: config.ylabel,
            colors: config.colors
          });

        states[s[0]] = {
          'graph': graph, 
          'data': data,
          'maxDataPoints': width * (reference / s[1])
        };
        
        ipc.on(`update-${s[0]}-${params.get('mac')}`, (event, arg) => {
          arg.unshift(data.length)
          data.push(arg)
        })
      })

      setInterval(() => Object.values(states).forEach(s => s['graph'].updateOptions({
        'file': s['data'], 
        'dateWindow': [s['data'].length - s['maxDataPoints'], s['data'].length] 
      }), refesh));
    </script>
  </body>
</html>